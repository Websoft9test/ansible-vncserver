# install VNCSERVER by OS_family
- name: Install this role on {{ansible_os_family}}
  include: "{{ansible_os_family}}.yml"

- name: Create vncserver System User
  user:
    name: vnc
    shell: /bin/bash
    home: /home/vnc
    create_home: yes

# copy and start vncpasswd.sh 
- name: Copy vncpasswd.sh
  copy:
    src:  vncpasswd.sh
    dest: /tmp/vncpasswd.sh
    owner: root
    group: root
    mode: '0750'

- name: Start vncpasswd.sh
  shell: . /tmp/vncpasswd.sh 

# Delete vnc cache
- name:
  shell: rm -rf /tmp/.X* /home/vnc/.vnc/*.pid /home/vnc/.vnc/*.log /tmp/vncpasswd.sh
#    pkill -9 vnc

# configure and start vncserver.service
- block:
  - name: Setting vncserver service
    copy:
      src: vncserver.service
      dest: /lib/systemd/system/vncserver.service

  - name: Restart vncserver
    service:
      name: vncserver
      state: restarted
      enabled: yes

# set soft link, -f enforce the exist links
# ln -sf src des
- name: set soft link
  shell: ln -sf /lib/systemd/system/vncserver.service /lib/systemd/system/vnc.service
    
# Check version,
# must use sudo sh -c to solve the no-root permission
- name: Check vncserver Version
  shell: sudo sh -c "'dpkg -l |grep tightvncserver || rpm -qa |grep tight-vncserver' 1>> /data/logs/install_version.txt"

# check service state
- name: Check vncserver Service
  shell: systemctl status vncserver | grep Active*
  register: check_vncserver_service
  notify: check_vncserver_service
